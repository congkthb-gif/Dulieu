<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ĐIỂM DANH → GOOGLE SHEET (HOÀN HẢO)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    * {box-sizing:border-box;}
    body {font-family: Arial, sans-serif; margin:0; padding:0; transition:all 0.4s; min-height:100vh;}
    h1 {font-size:9vw; margin:15px 0; text-align:center; color:white; text-shadow:2px 2px 8px rgba(0,0,0,0.6);}
    .mode-text {font-size:10vw; font-weight:bold; text-align:center; margin:20px 0; color:white; text-shadow:3px 3px 10px rgba(0,0,0,0.7);}
    .buttons {text-align:center; padding:20px 0;}
    .btn {width:90%; max-width:400px; margin:15px auto; display:block; padding:25px 0; font-size:9vw; font-weight:bold; border:none; border-radius:20px; color:white; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.4);}
    .vao {background:#137333;}
    .ra {background:#d93025;}
    .active {transform:scale(1.08); box-shadow:0 0 40px gold !important;}
    #quet {width:94%; margin:30px auto; display:block; padding:30px; font-size:7vw; text-align:center; border-radius:20px; border:6px dashed white; background:rgba(255,255,255,0.25); color:white; caret-color:white;}
    #quet::placeholder {color:rgba(255,255,255,0.8); font-size:6vw;}
    table {width:100%; border-collapse:collapse; font-size:5.5vw; margin-top:20px;}
    th, td {padding:14px 8px; text-align:center;}
    th {background:#1a73e8; color:white; font-size:6vw;}
    td:nth-child(1) {text-align:left; font-weight:bold; font-size:6vw;}
    .highlight {background:#ffeb3b !important;}
    .mode-vao {background:#a8d5ba;}
    .mode-ra  {background:#f4a8a2;}
    #thongbao {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:30px 50px; font-size:8vw; border-radius:20px; display:none; z-index:999;}
</style>
</head>
<body class="mode-vao">

<h1>ĐIỂM DANH</h1>
<div class="mode-text" id="cheDoText">ĐANG QUÉT VÀO LÀM</div>

<div class="buttons">
    <button id="btnVao" class="btn vao active">VÀO LÀM</button>
    <button id="btnRa"  class="btn ra">TAN LÀM</button>
</div>

<input type="text" id="quet" autofocus placeholder="QUÉT NGAY..." autocomplete="off">

<div id="thongbao">ĐÃ GỬI LÊN SHEET!</div>

<table id="bang">
    <thead>
        <tr>
            <th>Họ tên</th>
            <th>Ngày sinh</th>
            <th>Vào</th>
            <th>Ra</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// === DÁN URL MỚI NHẤT VÀO ĐÂY ===
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxJsvpiAZLQ5ZyhiUfGyn2N4rYOtFdGAMpqGDehjf89tmTSHSgwaq7YJmX2b2dj5WUE/exec";

let cheDo = "vao";
let danhSach = {};

const input = document.getElementById("quet");
const btnVao = document.getElementById("btnVao");
const btnRa = document.getElementById("btnRa");
const cheDoText = document.getElementById("cheDoText");
const thongbao = document.getElementById("thongbao");

btnVao.onclick = () => { cheDo = "vao"; update(); input.focus(); }
btnRa.onclick = () => { cheDo = "ra"; update(); input.focus(); }

function update() {
    document.body.className = cheDo === "vao" ? "mode-vao" : "mode-ra";
    btnVao.classList.toggle("active", cheDo === "vao");
    btnRa.classList.toggle("active", cheDo === "ra");
    cheDoText.textContent = cheDo === "vao" ? "ĐANG QUÉT VÀO LÀM" : "ĐANG QUÉT TAN LÀM";
}

function layThoiGian() {
    return new Date().toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
}

input.addEventListener("input", function() {
    let raw = this.value.trim();
    if ((raw.match(/,/g) || []).length >= 2) {
        xuLy(raw);
        this.value = "";
    }
});

input.addEventListener("keydown", e => {
    if (e.key === "Enter" && input.value.trim()) {
        xuLy(input.value.trim());
        input.value = "";
    }
});

function xuLy(raw) {
    let clean = raw.replace(/^\d+\.\s*/, '');
    let parts = clean.split(',').map(p => p.trim());
    if (parts.length < 2) return;

    let hoTen = parts[0].toUpperCase();
    let ngaySinh = parts[1];
    let tg = layThoiGian();
    let loai = cheDo === "vao" ? "Vào làm" : "Ra về";

    let key = `${hoTen}|${ngaySinh}`;
    if (!danhSach[key]) danhSach[key] = {hoTen, ngaySinh, gioVao: "", gioRa: ""};
    if (cheDo === "vao") danhSach[key].gioVao = tg;
    else danhSach[key].gioRa = tg;

    // Gửi lên Google Sheet
    fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({hoTen, ngaySinh, loai})
    }).then(() => {
        thongbao.style.display = "block";
        setTimeout(() => thongbao.style.display = "none", 1000);
    });

    hienThi();
}

function hienThi() {
    const tbody = document.querySelector("#bang tbody");
    tbody.innerHTML = "";
    Object.values(danhSach).forEach(p => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="text-align:left;">${p.hoTen}</td>
            <td>${p.ngaySinh}</td>
            <td>${p.gioVao || ""}</td>
            <td>${p.gioRa || ""}</td>
        `;
        tbody.appendChild(tr);
    });
}

update();
hienThi();
</script>
</body>
</html>