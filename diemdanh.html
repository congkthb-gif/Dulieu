<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ĐIỂM DANH</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    * {box-sizing:border-box;}
    body {font-family: Arial, sans-serif; margin:0; padding:10px 0; transition:all 0.4s; min-height:100vh;}
    h1 {font-size:7vw; margin:10px 0; text-align:center; color:white; text-shadow:2px 2px 6px rgba(0,0,0,0.6);}
    .buttons {text-align:center; padding:15px 0;}
    .btn {width:88%; max-width:380px; margin:12px auto; display:block; padding:20px 0; font-size:7.5vw; font-weight:bold; border:none; border-radius:18px; color:white; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.3);}
    .vao {background:#137333;}
    .ra {background:#d93025;}
    .active {transform:scale(1.06); box-shadow:0 0 35px gold !important;}
    #quet {width:92%; margin:20px auto; display:block; padding:22px; font-size:6vw; text-align:center; border-radius:18px; border:4px dashed rgba(255,255,255,0.7); background:rgba(255,255,255,0.2); color:white; caret-color:white;}
    #quet::placeholder {color:rgba(255,255,255,0.7); font-size:5.5vw;}
    table {width:100%; border-collapse:collapse; font-size:4.8vw; margin-top:15px;}
    th, td {padding:10px 6px; text-align:center;}
    th {background:#1a73e8; color:white; font-size:5vw;}
    td:nth-child(1) {text-align:left; font-weight:bold; font-size:5.2vw;}
    .highlight {background:#ffeb3b !important;}
    .mode-vao {background:#b8d5c4;}
    .mode-ra  {background:#f4b8b0;}
    #thongbao {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.85); color:white; padding:25px 45px; font-size:7vw; border-radius:18px; display:none; z-index:999;}
</style>
</head>
<body class="mode-vao">

<h1>ĐIỂM DANH</h1>

<div class="buttons">
    <button id="btnVao" class="btn vao active">VÀO LÀM</button>
    <button id="btnRa"  class="btn ra">TAN LÀM</button>
</div>

<input type="text" id="quet" autofocus placeholder="QUÉT TẠI ĐÂY..." autocomplete="off">

<div id="thongbao">ĐÃ GỬI!</div>

<table id="bang">
    <thead>
        <tr>
            <th>Họ tên</th>
            <th>Ngày sinh</th>
            <th>Vào</th>
            <th>Ra</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// === URL WEB APP CỦA BẠN ===
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxJsvpiAZLQ5ZyhiUfGyn2N4rYOtFdGAMpqGDehjf89tmTSHSgwaq7YJmX2b2dj5WUE/exec";

let cheDo = "vao";
let danhSach = {};
let buffer = "";
let timeoutId = null;

const input = document.getElementById("quet");
const btnVao = document.getElementById("btnVao");
const btnRa = document.getElementById("btnRa");
const thongbao = document.getElementById("thongbao");

btnVao.onclick = () => { cheDo = "vao"; update(); input.focus(); }
btnRa.onclick  = () => { cheDo = "ra"; update(); input.focus(); }

function update() {
    document.body.className = cheDo === "vao" ? "mode-vao" : "mode-ra";
    btnVao.classList.toggle("active", cheDo === "vao");
    btnRa.classList.toggle("active", cheDo === "ra");
}

// === CHUẨN HÓA TIẾNG VIỆT - FIX LỖI Ũ Ĩ Ì Đ... ===
function chuanHoaTen(str) {
    return str
        .replace(/[ÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴ]/g, "A")
        .replace(/[àáạảãâầấậẩẫăằắặẳẵ]/g, "a")
        .replace(/[ÈÉẸẺẼÊỀẾỆỂỄ]/g, "E")
        .replace(/[èéẹẻẽêềếệểễ]/g, "e")
        .replace(/[ÌÍỊỈĨ]/g, "I")
        .replace(/[ìíịỉĩ]/g, "i")
        .replace(/[ÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠ]/g, "O")
        .replace(/[òóọỏõôồốộổỗơờớợởỡ]/g, "o")
        .replace(/[ÙÚỤỦŨƯỪỨỰỬỮ]/g, "U")
        .replace(/[ùúụủũưừứựửữ]/g, "u")
        .replace(/[ỲÝỴỶỸ]/g, "Y")
        .replace(/[ỳýỵỷỹ]/g, "y")
        .replace(/[Đ]/g, "D")
        .replace(/[đ]/g, "d")
        .replace(/[^A-Za-z0-9\s\/,]/g, '')  // Loại bỏ mọi ký tự lạ còn lại
        .replace(/\s+/g, ' ')
        .trim();
}

function layThoiGian() {
    return new Date().toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
}

input.addEventListener("input", function(e) {
    buffer += this.value;
    this.value = "";

    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        if (buffer.trim() && (buffer.match(/,/g) || []).length >= 2) {
            xuLy(buffer.trim());
        }
        buffer = "";
    }, 350);
});

function xuLy(raw) {
    let clean = raw.replace(/^\d+\.\s*/, '');
    let parts = clean.split(',').map(p => p.trim());
    if (parts.length < 2) return;

    // === ÁP DỤNG CHUẨN HÓA TIẾNG VIỆT ===
    let hoTenRaw = parts[0];
    let hoTen = chuanHoaTen(hoTenRaw).toUpperCase();  // Chuẩn hóa + in hoa
    let ngaySinh = parts[1].trim();

    let tg = layThoiGian();
    let loai = cheDo === "vao" ? "Vào làm" : "Ra về";

    let key = `${hoTen}|${ngaySinh}`;
    if (!danhSach[key]) danhSach[key] = {hoTen, ngaySinh, gioVao: "", gioRa: ""};
    if (cheDo === "vao") danhSach[key].gioVao = tg;
    else danhSach[key].gioRa = tg;

    fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({hoTen, ngaySinh, loai})
    });

    thongbao.style.display = "block";
    setTimeout(() => thongbao.style.display = "none", 600);

    hienThi();
}

function hienThi() {
    const tbody = document.querySelector("#bang tbody");
    tbody.innerHTML = "";
    Object.values(danhSach).forEach(p => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="text-align:left;">${p.hoTen}</td>
            <td>${p.ngaySinh}</td>
            <td>${p.gioVao || ""}</td>
            <td>${p.gioRa || ""}</td>
        `;
        tbody.appendChild(tr);
    });
}

update();
hienThi();
</script>
</body>
</html>
